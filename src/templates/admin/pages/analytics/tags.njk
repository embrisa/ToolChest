{% extends "layouts/admin-layout.njk" %}

{% block title %}{{ title }}{% endblock %}

{% block headContent %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold" style="color: var(--sand-100);">Tag Analytics</h1>
            <p class="mt-2" style="color: var(--neutral-400);">Detailed usage statistics and insights for all tags</p>
        </div>
        <div class="flex space-x-3">
            <a href="/admin/analytics" 
               class="px-6 py-3 rounded-xl transition-all duration-200 hover:scale-105 border inline-flex items-center"
               style="background: rgba(254, 247, 237, 0.1); 
                      color: var(--sand-200); 
                      border-color: rgba(254, 247, 237, 0.2);
                      hover:background: rgba(254, 247, 237, 0.15);">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
            <button 
                type="button" 
                class="px-6 py-3 rounded-xl transition-all duration-200 hover:scale-105 border"
                style="background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%); 
                       color: white; 
                       border-color: rgba(255, 255, 255, 0.1);
                       box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 
                                   0 4px 12px rgba(0, 0, 0, 0.15);"
                hx-get="/admin/analytics/tags"
                hx-target="#tags-content"
                hx-swap="outerHTML"
            >
                <i class="fas fa-refresh mr-2"></i>Refresh Data
            </button>
        </div>
    </div>

    <!-- Tags Content -->
    <div id="tags-content">
        <!-- Search and Filters -->
        <div class="rounded-xl border p-6 mb-6"
             style="background: rgba(254, 247, 237, 0.08); 
                    border-color: rgba(254, 247, 237, 0.08);
                    box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                0 12px 48px rgba(0, 0, 0, 0.12);">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--sand-200);">Search Tags</label>
                    <input type="text" 
                           id="tagSearch"
                           placeholder="Search by name or slug..."
                           class="w-full px-4 py-3 rounded-xl border transition-all duration-200"
                           style="background: rgba(254, 247, 237, 0.1); 
                                  color: var(--sand-100); 
                                  border-color: rgba(254, 247, 237, 0.15);
                                  focus:border-color: var(--blue-400);
                                  focus:ring: 0 0 0 3px rgba(51, 141, 255, 0.1);"
                           oninput="filterTags()">
                </div>

                <!-- Usage Filter -->
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--sand-200);">Usage</label>
                    <select id="usageFilter" 
                            class="w-full px-4 py-3 rounded-xl border transition-all duration-200"
                            style="background: rgba(254, 247, 237, 0.1); 
                                   color: var(--sand-100); 
                                   border-color: rgba(254, 247, 237, 0.15);
                                   focus:border-color: var(--blue-400);"
                            onchange="filterTags()">
                        <option value="all">All Tags</option>
                        <option value="used">With Tools</option>
                        <option value="unused">Unused Tags</option>
                    </select>
                </div>

                <!-- Sort -->
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--sand-200);">Sort By</label>
                    <select id="sortFilter" 
                            class="w-full px-4 py-3 rounded-xl border transition-all duration-200"
                            style="background: rgba(254, 247, 237, 0.1); 
                                   color: var(--sand-100); 
                                   border-color: rgba(254, 247, 237, 0.15);
                                   focus:border-color: var(--blue-400);"
                            onchange="filterTags()">
                        <option value="usage">Tool Count (High to Low)</option>
                        <option value="usage-asc">Tool Count (Low to High)</option>
                        <option value="name">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="total-usage">Total Usage (High to Low)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Total Tags -->
            <div class="p-6 rounded-xl border"
                 style="background: rgba(254, 247, 237, 0.1); 
                        border-color: rgba(254, 247, 237, 0.08);
                        box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                    0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl" style="background: rgba(245, 168, 103, 0.2);">
                        <i class="fas fa-tags" style="color: var(--sand-400);"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium" style="color: var(--neutral-400);">Total Tags</p>
                        <p class="text-2xl font-bold" style="color: var(--sand-100);">{{ topTags.length }}</p>
                    </div>
                </div>
            </div>

            <!-- Tags in Use -->
            <div class="p-6 rounded-xl border"
                 style="background: rgba(254, 247, 237, 0.1); 
                        border-color: rgba(254, 247, 237, 0.08);
                        box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                    0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl" style="background: rgba(16, 185, 129, 0.1);">
                        <i class="fas fa-link" style="color: var(--green-400);"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium" style="color: var(--neutral-400);">Tags in Use</p>
                        <p class="text-2xl font-bold" style="color: var(--sand-100);">{{ topTags | selectattr('toolCount') | selectattr('toolCount', '>', 0) | list | length }}</p>
                    </div>
                </div>
            </div>

            <!-- Total Tool Connections -->
            <div class="p-6 rounded-xl border"
                 style="background: rgba(254, 247, 237, 0.1); 
                        border-color: rgba(254, 247, 237, 0.08);
                        box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                    0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl" style="background: rgba(255, 140, 66, 0.15);">
                        <i class="fas fa-project-diagram" style="color: var(--sunset-400);"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium" style="color: var(--neutral-400);">Tool Connections</p>
                        <p class="text-2xl font-bold" style="color: var(--sand-100);">{{ topTags | sum(attribute='toolCount') }}</p>
                    </div>
                </div>
            </div>

            <!-- Average Tools per Tag -->
            <div class="p-6 rounded-xl border"
                 style="background: rgba(254, 247, 237, 0.1); 
                        border-color: rgba(254, 247, 237, 0.08);
                        box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                    0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl" style="background: rgba(252, 211, 77, 0.15);">
                        <i class="fas fa-calculator" style="color: var(--sand-300);"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium" style="color: var(--neutral-400);">Avg Tools/Tag</p>
                        <p class="text-2xl font-bold" style="color: var(--sand-100);">
                            {% if topTags.length > 0 %}
                                {{ ((topTags | sum(attribute='toolCount')) / topTags.length) | round(1) }}
                            {% else %}
                                0
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tags Table -->
        <div class="rounded-xl border"
             style="background: rgba(254, 247, 237, 0.08); 
                    border-color: rgba(254, 247, 237, 0.08);
                    box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                0 12px 48px rgba(0, 0, 0, 0.12);">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold" style="color: var(--sand-100);">All Tags</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm" style="color: var(--neutral-400);">Showing</span>
                        <span id="tagCount" class="font-medium" style="color: var(--sand-200);">{{ topTags.length }}</span>
                        <span class="text-sm" style="color: var(--neutral-400);">tags</span>
                    </div>
                </div>

                <div id="tagsTable" class="space-y-4">
                    {% for tag in topTags %}
                    <div class="tag-row p-6 rounded-xl border transition-all duration-200 hover:scale-105" 
                         data-name="{{ tag.name | lower }}"
                         data-slug="{{ tag.id | lower }}"
                         data-usage="{{ tag.toolCount }}"
                         data-total-usage="{{ tag.totalUsage }}"
                         style="background: rgba(254, 247, 237, 0.1); 
                                border-color: rgba(254, 247, 237, 0.15);">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- Tag Color -->
                                <div class="flex-shrink-0">
                                    <span 
                                        class="inline-block w-8 h-8 rounded-full border border-white/20"
                                        style="background-color: {{ tag.color or '#6B7280' }}; 
                                               box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);"
                                    ></span>
                                </div>

                                <!-- Tag Info -->
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3">
                                        <h4 class="text-lg font-semibold" style="color: var(--sand-100);">{{ tag.name }}</h4>
                                        {% if tag.toolCount > 0 %}
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border"
                                                  style="background: rgba(16, 185, 129, 0.1); 
                                                         color: var(--green-400); 
                                                         border-color: rgba(16, 185, 129, 0.2);">
                                                <i class="fas fa-link mr-1"></i>In Use
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border"
                                                  style="background: rgba(156, 163, 175, 0.1); 
                                                         color: var(--neutral-400); 
                                                         border-color: rgba(156, 163, 175, 0.2);">
                                                <i class="fas fa-circle mr-1"></i>Unused
                                            </span>
                                        {% endif %}
                                    </div>
                                    <p class="text-sm mt-1" style="color: var(--neutral-500);">{{ tag.id }}</p>
                                </div>
                            </div>

                            <!-- Usage Stats & Actions -->
                            <div class="flex items-center space-x-6">
                                <!-- Tool Count -->
                                <div class="text-center">
                                    <p class="text-2xl font-bold" style="color: var(--blue-400);">{{ tag.toolCount or 0 }}</p>
                                    <p class="text-xs" style="color: var(--neutral-500);">tools</p>
                                </div>

                                <!-- Total Usage -->
                                <div class="text-center">
                                    <p class="text-lg font-semibold" style="color: var(--sunset-400);">{{ tag.totalUsage or 0 }}</p>
                                    <p class="text-xs" style="color: var(--neutral-500);">total usage</p>
                                </div>

                                <!-- Actions -->
                                <div class="flex items-center space-x-2">
                                    <a href="/admin/tags/{{ tag.id }}" 
                                       class="p-2 rounded-lg transition-all duration-200 hover:scale-105 border"
                                       style="color: var(--blue-400); 
                                              border-color: rgba(51, 141, 255, 0.3);
                                              background: rgba(51, 141, 255, 0.1);
                                              hover:background: rgba(51, 141, 255, 0.15);"
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/admin/tags/{{ tag.id }}/edit" 
                                       class="p-2 rounded-lg transition-all duration-200 hover:scale-105 border"
                                       style="color: var(--sand-400); 
                                              border-color: rgba(245, 168, 103, 0.3);
                                              background: rgba(245, 168, 103, 0.1);
                                              hover:background: rgba(245, 168, 103, 0.15);"
                                       title="Edit Tag">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="/admin/relationships?tagId={{ tag.id }}" 
                                       class="p-2 rounded-lg transition-all duration-200 hover:scale-105 border"
                                       style="color: var(--sunset-400); 
                                              border-color: rgba(255, 140, 66, 0.3);
                                              background: rgba(255, 140, 66, 0.1);
                                              hover:background: rgba(255, 140, 66, 0.15);"
                                       title="Manage Relationships">
                                        <i class="fas fa-link"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Associated Tools Preview -->
                        {% if tag.tools and tag.tools.length > 0 %}
                        <div class="mt-4 pt-4 border-t" style="border-color: rgba(254, 247, 237, 0.1);">
                            <div class="flex flex-wrap gap-2">
                                {% for tool in tag.tools | slice(0, 5) %}
                                <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs border"
                                      style="background: rgba(51, 141, 255, 0.1); 
                                             color: var(--blue-300); 
                                             border-color: rgba(51, 141, 255, 0.2);">
                                    {{ tool.toolName }}
                                    {% if tool.usage > 0 %}
                                        <span class="ml-1 text-xs" style="color: var(--neutral-400);">({{ tool.usage }})</span>
                                    {% endif %}
                                </span>
                                {% endfor %}
                                {% if tag.tools.length > 5 %}
                                <span class="text-xs" style="color: var(--neutral-400);">
                                    +{{ tag.tools.length - 5 }} more
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <div class="p-4 rounded-full mx-auto w-16 h-16 flex items-center justify-center mb-4"
                             style="background: rgba(156, 163, 175, 0.1);">
                            <i class="fas fa-tags text-2xl" style="color: var(--neutral-400);"></i>
                        </div>
                        <p style="color: var(--neutral-400);">No tags found</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Tag Distribution Chart -->
        {% if tagStats.length > 0 %}
        <div class="rounded-xl border p-6 mt-8"
             style="background: rgba(254, 247, 237, 0.08); 
                    border-color: rgba(254, 247, 237, 0.08);
                    box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                0 12px 48px rgba(0, 0, 0, 0.12);">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold" style="color: var(--sand-100);">Tag Distribution by Tool Count</h3>
                <div class="flex items-center space-x-2">
                    <button class="text-sm px-3 py-1 rounded-lg border"
                            style="color: var(--sand-400); border-color: rgba(245, 168, 103, 0.3);"
                            onclick="toggleChartType()">Toggle Chart</button>
                </div>
            </div>
            <div class="h-80">
                <canvas id="distributionChart" width="400" height="200"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="rounded-xl border p-6 mt-8"
             style="background: rgba(254, 247, 237, 0.08); 
                    border-color: rgba(254, 247, 237, 0.08);
                    box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                0 12px 48px rgba(0, 0, 0, 0.12);">
            <h3 class="text-xl font-semibold mb-6" style="color: var(--sand-100);">Quick Actions</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a href="/admin/tags/create" class="analytics-quick-action">
                    <i class="fas fa-plus text-2xl mb-3" style="color: var(--sand-400);"></i>
                    <h4 class="font-medium mb-2" style="color: var(--sand-100);">Create New Tag</h4>
                    <p class="text-sm" style="color: var(--neutral-400);">Add a new tag category</p>
                </a>
                
                <a href="/admin/relationships" class="analytics-quick-action">
                    <i class="fas fa-link text-2xl mb-3" style="color: var(--sunset-400);"></i>
                    <h4 class="font-medium mb-2" style="color: var(--sand-100);">Manage Relationships</h4>
                    <p class="text-sm" style="color: var(--neutral-400);">Assign tags to tools</p>
                </a>
                
                <a href="/admin/analytics/export?type=tags&format=csv" class="analytics-quick-action">
                    <i class="fas fa-download text-2xl mb-3" style="color: var(--blue-400);"></i>
                    <h4 class="font-medium mb-2" style="color: var(--sand-100);">Export Data</h4>
                    <p class="text-sm" style="color: var(--neutral-400);">Download tag analytics as CSV</p>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Tag filtering functionality
function filterTags() {
    const searchTerm = document.getElementById('tagSearch').value.toLowerCase();
    const usageFilter = document.getElementById('usageFilter').value;
    const sortFilter = document.getElementById('sortFilter').value;
    
    const tagRows = document.querySelectorAll('.tag-row');
    let visibleCount = 0;
    
    // Convert NodeList to Array for sorting
    const rowsArray = Array.from(tagRows);
    
    // Filter and sort
    rowsArray.forEach(row => {
        const name = row.dataset.name;
        const slug = row.dataset.slug;
        const usage = parseInt(row.dataset.usage);
        
        // Apply filters
        let show = true;
        
        // Search filter
        if (searchTerm && !name.includes(searchTerm) && !slug.includes(searchTerm)) {
            show = false;
        }
        
        // Usage filter
        if (usageFilter === 'used' && usage === 0) {
            show = false;
        } else if (usageFilter === 'unused' && usage > 0) {
            show = false;
        }
        
        if (show) {
            row.style.display = 'block';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Sort visible rows
    const visibleRows = rowsArray.filter(row => row.style.display !== 'none');
    
    visibleRows.sort((a, b) => {
        switch (sortFilter) {
            case 'usage':
                return parseInt(b.dataset.usage) - parseInt(a.dataset.usage);
            case 'usage-asc':
                return parseInt(a.dataset.usage) - parseInt(b.dataset.usage);
            case 'name':
                return a.dataset.name.localeCompare(b.dataset.name);
            case 'name-desc':
                return b.dataset.name.localeCompare(a.dataset.name);
            case 'total-usage':
                return parseInt(b.dataset.totalUsage) - parseInt(a.dataset.totalUsage);
            default:
                return 0;
        }
    });
    
    // Reorder DOM elements
    const container = document.getElementById('tagsTable');
    visibleRows.forEach(row => {
        container.appendChild(row);
    });
    
    // Update count
    document.getElementById('tagCount').textContent = visibleCount;
}

// Chart variables
let currentChart = null;
let isBarChart = true;

// Toggle chart type
function toggleChartType() {
    if (currentChart) {
        currentChart.destroy();
    }
    isBarChart = !isBarChart;
    initializeChart();
}

// Initialize charts if data exists
{% if tagStats.length > 0 %}
function initializeChart() {
    const ctx = document.getElementById('distributionChart');
    if (ctx && typeof Chart !== 'undefined') {
        const tagData = {{ topTags | list | dump | safe }};
        
        const labels = tagData.map(tag => tag.name);
        const data = tagData.map(tag => tag.toolCount);
        const colors = tagData.map(tag => tag.color || '#6B7280');
        
        const config = {
            type: isBarChart ? 'bar' : 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Tool Count',
                    data: data,
                    backgroundColor: isBarChart ? colors.map(c => c + '80') : colors,
                    borderColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: !isBarChart,
                        labels: {
                            color: 'rgba(254, 247, 237, 0.8)'
                        }
                    }
                },
                scales: isBarChart ? {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(254, 247, 237, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(254, 247, 237, 0.6)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(254, 247, 237, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(254, 247, 237, 0.6)',
                            maxRotation: 45
                        }
                    }
                } : {}
            }
        };
        
        currentChart = new Chart(ctx, config);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
});
{% endif %}
</script>

{% endblock %} 