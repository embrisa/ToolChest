{% extends "layouts/admin-layout.njk" %}

{% block title %}{{ title }}{% endblock %}

{% block headContent %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold" style="color: var(--sand-100);">Tool Analytics</h1>
            <p class="mt-2" style="color: var(--neutral-400);">Detailed usage statistics and insights for all tools</p>
        </div>
        <div class="flex space-x-3">
            <a href="/admin/analytics" 
               class="px-6 py-3 rounded-xl transition-all duration-200 hover:scale-105 border inline-flex items-center"
               style="background: rgba(254, 247, 237, 0.1); 
                      color: var(--sand-200); 
                      border-color: rgba(254, 247, 237, 0.2);
                      hover:background: rgba(254, 247, 237, 0.15);">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
            <button 
                type="button" 
                class="px-6 py-3 rounded-xl transition-all duration-200 hover:scale-105 border"
                style="background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%); 
                       color: white; 
                       border-color: rgba(255, 255, 255, 0.1);
                       box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 
                                   0 4px 12px rgba(0, 0, 0, 0.15);"
                hx-get="/admin/analytics/tools"
                hx-target="#tools-content"
                hx-swap="outerHTML"
            >
                <i class="fas fa-refresh mr-2"></i>Refresh Data
            </button>
        </div>
    </div>

    <!-- Tools Content -->
    <div id="tools-content">
        <!-- Search and Filters -->
        <div class="rounded-xl border p-6 mb-6"
             style="background: rgba(254, 247, 237, 0.08); 
                    border-color: rgba(254, 247, 237, 0.08);
                    box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                0 12px 48px rgba(0, 0, 0, 0.12);">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--sand-200);">Search Tools</label>
                    <input type="text" 
                           id="toolSearch"
                           placeholder="Search by name or slug..."
                           class="w-full px-4 py-3 rounded-xl border transition-all duration-200"
                           style="background: rgba(254, 247, 237, 0.1); 
                                  color: var(--sand-100); 
                                  border-color: rgba(254, 247, 237, 0.15);
                                  focus:border-color: var(--blue-400);
                                  focus:ring: 0 0 0 3px rgba(51, 141, 255, 0.1);"
                           oninput="filterTools()">
                </div>

                <!-- Status Filter -->
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--sand-200);">Status</label>
                    <select id="statusFilter" 
                            class="w-full px-4 py-3 rounded-xl border transition-all duration-200"
                            style="background: rgba(254, 247, 237, 0.1); 
                                   color: var(--sand-100); 
                                   border-color: rgba(254, 247, 237, 0.15);
                                   focus:border-color: var(--blue-400);"
                            onchange="filterTools()">
                        <option value="all">All Tools</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                    </select>
                </div>

                <!-- Sort -->
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--sand-200);">Sort By</label>
                    <select id="sortFilter" 
                            class="w-full px-4 py-3 rounded-xl border transition-all duration-200"
                            style="background: rgba(254, 247, 237, 0.1); 
                                   color: var(--sand-100); 
                                   border-color: rgba(254, 247, 237, 0.15);
                                   focus:border-color: var(--blue-400);"
                            onchange="filterTools()">
                        <option value="usage">Usage (High to Low)</option>
                        <option value="usage-asc">Usage (Low to High)</option>
                        <option value="name">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="created">Recently Created</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Total Tools -->
            <div class="p-6 rounded-xl border"
                 style="background: rgba(254, 247, 237, 0.1); 
                        border-color: rgba(254, 247, 237, 0.08);
                        box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                    0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl" style="background: rgba(51, 141, 255, 0.1);">
                        <i class="fas fa-tools" style="color: var(--blue-400);"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium" style="color: var(--neutral-400);">Total Tools</p>
                        <p class="text-2xl font-bold" style="color: var(--sand-100);">{{ topTools.length }}</p>
                    </div>
                </div>
            </div>

            <!-- Active Tools -->
            <div class="p-6 rounded-xl border"
                 style="background: rgba(254, 247, 237, 0.1); 
                        border-color: rgba(254, 247, 237, 0.08);
                        box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                    0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl" style="background: rgba(16, 185, 129, 0.1);">
                        <i class="fas fa-check-circle" style="color: var(--green-400);"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium" style="color: var(--neutral-400);">Active Tools</p>
                        <p class="text-2xl font-bold" style="color: var(--sand-100);">{{ topTools | selectattr('isActive') | list | length }}</p>
                    </div>
                </div>
            </div>

            <!-- Total Usage -->
            <div class="p-6 rounded-xl border"
                 style="background: rgba(254, 247, 237, 0.1); 
                        border-color: rgba(254, 247, 237, 0.08);
                        box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                    0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl" style="background: rgba(255, 140, 66, 0.15);">
                        <i class="fas fa-chart-line" style="color: var(--sunset-400);"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium" style="color: var(--neutral-400);">Total Usage</p>
                        <p class="text-2xl font-bold" style="color: var(--sand-100);">{{ topTools | sum(attribute='totalUsage') }}</p>
                    </div>
                </div>
            </div>

            <!-- Average Usage -->
            <div class="p-6 rounded-xl border"
                 style="background: rgba(254, 247, 237, 0.1); 
                        border-color: rgba(254, 247, 237, 0.08);
                        box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                    0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="flex items-center">
                    <div class="p-3 rounded-xl" style="background: rgba(252, 211, 77, 0.15);">
                        <i class="fas fa-calculator" style="color: var(--sand-300);"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium" style="color: var(--neutral-400);">Avg Usage</p>
                        <p class="text-2xl font-bold" style="color: var(--sand-100);">
                            {% if topTools.length > 0 %}
                                {{ ((topTools | sum(attribute='totalUsage')) / topTools.length) | round }}
                            {% else %}
                                0
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Table -->
        <div class="rounded-xl border"
             style="background: rgba(254, 247, 237, 0.08); 
                    border-color: rgba(254, 247, 237, 0.08);
                    box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                0 12px 48px rgba(0, 0, 0, 0.12);">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold" style="color: var(--sand-100);">All Tools</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm" style="color: var(--neutral-400);">Showing</span>
                        <span id="toolCount" class="font-medium" style="color: var(--sand-200);">{{ topTools.length }}</span>
                        <span class="text-sm" style="color: var(--neutral-400);">tools</span>
                    </div>
                </div>

                <div id="toolsTable" class="space-y-4">
                    {% for tool in topTools %}
                    <div class="tool-row p-6 rounded-xl border transition-all duration-200 hover:scale-105" 
                         data-name="{{ tool.name | lower }}"
                         data-slug="{{ tool.slug | lower }}"
                         data-status="{{ tool.isActive }}"
                         data-usage="{{ tool.totalUsage }}"
                         style="background: rgba(254, 247, 237, 0.1); 
                                border-color: rgba(254, 247, 237, 0.15);">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- Tool Icon -->
                                <div class="flex-shrink-0 p-3 rounded-xl" 
                                     style="background: rgba(245, 168, 103, 0.1);">
                                    <i class="{{ tool.iconClass or 'fas fa-tools' }}" style="color: var(--sand-400);"></i>
                                </div>

                                <!-- Tool Info -->
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3">
                                        <h4 class="text-lg font-semibold" style="color: var(--sand-100);">{{ tool.name }}</h4>
                                        {% if tool.isActive %}
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border"
                                                  style="background: rgba(16, 185, 129, 0.1); 
                                                         color: var(--green-400); 
                                                         border-color: rgba(16, 185, 129, 0.2);">
                                                <i class="fas fa-check-circle mr-1"></i>Active
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border"
                                                  style="background: rgba(156, 163, 175, 0.1); 
                                                         color: var(--neutral-400); 
                                                         border-color: rgba(156, 163, 175, 0.2);">
                                                <i class="fas fa-pause-circle mr-1"></i>Inactive
                                            </span>
                                        {% endif %}
                                    </div>
                                    <p class="text-sm mt-1" style="color: var(--neutral-500);">{{ tool.slug }}</p>
                                </div>
                            </div>

                            <!-- Usage Stats & Actions -->
                            <div class="flex items-center space-x-6">
                                <!-- Usage -->
                                <div class="text-right">
                                    <p class="text-2xl font-bold" style="color: var(--blue-400);">{{ tool.totalUsage or 0 }}</p>
                                    <p class="text-xs" style="color: var(--neutral-500);">total uses</p>
                                </div>

                                <!-- Actions -->
                                <div class="flex items-center space-x-2">
                                    <a href="/admin/tools/{{ tool.id }}" 
                                       class="p-2 rounded-lg transition-all duration-200 hover:scale-105 border"
                                       style="color: var(--blue-400); 
                                              border-color: rgba(51, 141, 255, 0.3);
                                              background: rgba(51, 141, 255, 0.1);
                                              hover:background: rgba(51, 141, 255, 0.15);"
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/admin/tools/{{ tool.id }}/edit" 
                                       class="p-2 rounded-lg transition-all duration-200 hover:scale-105 border"
                                       style="color: var(--sand-400); 
                                              border-color: rgba(245, 168, 103, 0.3);
                                              background: rgba(245, 168, 103, 0.1);
                                              hover:background: rgba(245, 168, 103, 0.15);"
                                       title="Edit Tool">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <div class="p-4 rounded-full mx-auto w-16 h-16 flex items-center justify-center mb-4"
                             style="background: rgba(156, 163, 175, 0.1);">
                            <i class="fas fa-tools text-2xl" style="color: var(--neutral-400);"></i>
                        </div>
                        <p style="color: var(--neutral-400);">No tools found</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Usage Trends Chart -->
        {% if toolTrends.length > 0 %}
        <div class="rounded-xl border p-6 mt-8"
             style="background: rgba(254, 247, 237, 0.08); 
                    border-color: rgba(254, 247, 237, 0.08);
                    box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                0 12px 48px rgba(0, 0, 0, 0.12);">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold" style="color: var(--sand-100);">Usage Trends ({{ days }} Days)</h3>
                <div class="flex space-x-2">
                    <button class="text-sm px-3 py-1 rounded-lg border"
                            style="color: var(--blue-400); border-color: rgba(51, 141, 255, 0.3);"
                            onclick="setTrendsPeriod(7)">7D</button>
                    <button class="text-sm px-3 py-1 rounded-lg border"
                            style="color: var(--blue-400); border-color: rgba(51, 141, 255, 0.3);"
                            onclick="setTrendsPeriod(30)">30D</button>
                    <button class="text-sm px-3 py-1 rounded-lg border"
                            style="color: var(--blue-400); border-color: rgba(51, 141, 255, 0.3);"
                            onclick="setTrendsPeriod(90)">90D</button>
                </div>
            </div>
            <div class="h-80">
                <canvas id="trendsChart" width="400" height="200"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="rounded-xl border p-6 mt-8"
             style="background: rgba(254, 247, 237, 0.08); 
                    border-color: rgba(254, 247, 237, 0.08);
                    box-shadow: inset 0 1px 0 rgba(254, 247, 237, 0.05), 
                                0 12px 48px rgba(0, 0, 0, 0.12);">
            <h3 class="text-xl font-semibold mb-6" style="color: var(--sand-100);">Quick Actions</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a href="/admin/tools/create" class="analytics-quick-action">
                    <i class="fas fa-plus text-2xl mb-3" style="color: var(--blue-400);"></i>
                    <h4 class="font-medium mb-2" style="color: var(--sand-100);">Create New Tool</h4>
                    <p class="text-sm" style="color: var(--neutral-400);">Add a new tool to your collection</p>
                </a>
                
                <a href="/admin/tools" class="analytics-quick-action">
                    <i class="fas fa-list text-2xl mb-3" style="color: var(--sand-400);"></i>
                    <h4 class="font-medium mb-2" style="color: var(--sand-100);">Manage All Tools</h4>
                    <p class="text-sm" style="color: var(--neutral-400);">Edit, organize, and manage your tools</p>
                </a>
                
                <a href="/admin/analytics/export?type=tools&format=csv" class="analytics-quick-action">
                    <i class="fas fa-download text-2xl mb-3" style="color: var(--sunset-400);"></i>
                    <h4 class="font-medium mb-2" style="color: var(--sand-100);">Export Data</h4>
                    <p class="text-sm" style="color: var(--neutral-400);">Download tool analytics as CSV</p>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Tool filtering functionality
function filterTools() {
    const searchTerm = document.getElementById('toolSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const sortFilter = document.getElementById('sortFilter').value;
    
    const toolRows = document.querySelectorAll('.tool-row');
    let visibleCount = 0;
    
    // Convert NodeList to Array for sorting
    const rowsArray = Array.from(toolRows);
    
    // Filter and sort
    rowsArray.forEach(row => {
        const name = row.dataset.name;
        const slug = row.dataset.slug;
        const status = row.dataset.status === 'true';
        
        // Apply filters
        let show = true;
        
        // Search filter
        if (searchTerm && !name.includes(searchTerm) && !slug.includes(searchTerm)) {
            show = false;
        }
        
        // Status filter
        if (statusFilter === 'active' && !status) {
            show = false;
        } else if (statusFilter === 'inactive' && status) {
            show = false;
        }
        
        if (show) {
            row.style.display = 'block';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Sort visible rows
    const visibleRows = rowsArray.filter(row => row.style.display !== 'none');
    
    visibleRows.sort((a, b) => {
        switch (sortFilter) {
            case 'usage':
                return parseInt(b.dataset.usage) - parseInt(a.dataset.usage);
            case 'usage-asc':
                return parseInt(a.dataset.usage) - parseInt(b.dataset.usage);
            case 'name':
                return a.dataset.name.localeCompare(b.dataset.name);
            case 'name-desc':
                return b.dataset.name.localeCompare(a.dataset.name);
            default:
                return 0;
        }
    });
    
    // Reorder DOM elements
    const container = document.getElementById('toolsTable');
    visibleRows.forEach(row => {
        container.appendChild(row);
    });
    
    // Update count
    document.getElementById('toolCount').textContent = visibleCount;
}

// Trends period selector
function setTrendsPeriod(days) {
    window.location.href = `/admin/analytics/tools?days=${days}`;
}

// Initialize charts if data exists
{% if toolTrends.length > 0 %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('trendsChart');
    if (ctx && typeof Chart !== 'undefined') {
        // Prepare data for top 5 tools
        const topTrends = {{ toolTrends | sort(attribute='totalUsage', reverse=true) | list | slice(0, 5) | dump | safe }};
        
        const datasets = topTrends.map((trend, index) => {
            const colors = [
                '#3b82f6', '#f59e0b', '#ef4444', '#10b981', '#8b5cf6'
            ];
            return {
                label: trend.toolName,
                data: trend.dailyUsage.map(day => day.usage),
                borderColor: colors[index],
                backgroundColor: colors[index] + '20',
                tension: 0.4,
                fill: false
            };
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: topTrends[0]?.dailyUsage.map(day => {
                    const date = new Date(day.date);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }) || [],
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: 'rgba(254, 247, 237, 0.8)'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(254, 247, 237, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(254, 247, 237, 0.6)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(254, 247, 237, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(254, 247, 237, 0.6)'
                        }
                    }
                }
            }
        });
    }
});
{% endif %}
</script>

{% endblock %} 