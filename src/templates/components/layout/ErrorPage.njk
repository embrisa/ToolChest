{# Error Page Component Library #}

{# Main ErrorPage Component #}
{% macro ErrorPage(config = {}) %}
  {% set defaults = {
    statusCode: 500,
    title: null,
    message: null,
    details: null,
    showDetails: false,
    stack: null,
    showStack: false,
    actions: {
      showHome: true,
      showBack: true,
      showRefresh: false,
      custom: []
    },
    icon: null,
    variant: 'modern',
    fullHeight: true,
    centered: true
  } %}
  {% set cfg = defaults | merge(config) %}

  {# Auto-configure based on status code #}
  {% set errorConfig = {
    400: { title: 'Bad Request', message: 'The request could not be understood by the server.', icon: 'fas fa-exclamation-triangle' },
    401: { title: 'Unauthorized', message: 'You need to sign in to access this resource.', icon: 'fas fa-lock' },
    403: { title: 'Forbidden', message: 'You don\'t have permission to access this resource.', icon: 'fas fa-ban' },
    404: { title: 'Page Not Found', message: 'The page you\'re looking for doesn\'t exist.', icon: 'fas fa-search' },
    405: { title: 'Method Not Allowed', message: 'The request method is not supported for this resource.', icon: 'fas fa-times-circle' },
    408: { title: 'Request Timeout', message: 'The server timed out waiting for the request.', icon: 'fas fa-clock' },
    429: { title: 'Too Many Requests', message: 'You\'ve made too many requests. Please try again later.', icon: 'fas fa-tachometer-alt' },
    500: { title: 'Internal Server Error', message: 'Something went wrong on our end. We\'re working to fix it.', icon: 'fas fa-server' },
    502: { title: 'Bad Gateway', message: 'The server received an invalid response.', icon: 'fas fa-plug' },
    503: { title: 'Service Unavailable', message: 'The service is temporarily unavailable. Please try again later.', icon: 'fas fa-tools' },
    504: { title: 'Gateway Timeout', message: 'The server didn\'t receive a timely response.', icon: 'fas fa-hourglass-half' }
  }[cfg.statusCode] or { title: 'Error', message: 'An unexpected error occurred.', icon: 'fas fa-exclamation-circle' } %}

  {# Use defaults if not provided #}
  {% set finalTitle = cfg.title or errorConfig.title %}
  {% set finalMessage = cfg.message or errorConfig.message %}
  {% set finalIcon = cfg.icon or errorConfig.icon %}

  {# Container classes #}
  {% set containerClasses = [] %}
  {% if cfg.fullHeight %}
    {% set containerClasses = containerClasses + ['min-h-[calc(100vh-10rem)]'] %}
  {% endif %}
  {% if cfg.centered %}
    {% set containerClasses = containerClasses + ['flex', 'flex-col', 'items-center', 'justify-center'] %}
  {% endif %}

  <section class="error-page {{ containerClasses | join(' ') }} text-center gap-6 px-4" 
           data-error-variant="{{ cfg.variant }}"
           data-status-code="{{ cfg.statusCode }}">
    
    {# Error Icon and Status Code #}
    <div class="error-header">
      {% if cfg.variant == 'modern' %}
        <div class="error-icon-container w-24 h-24 mx-auto mb-6 navbar-modern rounded-3xl flex items-center justify-center">
          <i class="{{ finalIcon }} text-4xl text-error"></i>
        </div>
        <span class="error-status-code text-6xl font-black text-error block mb-4">{{ cfg.statusCode }}</span>
      {% elif cfg.variant == 'minimal' %}
        <span class="error-status-code text-8xl font-black text-error block mb-4">{{ cfg.statusCode }}</span>
      {% elif cfg.variant == 'illustrated' %}
        <div class="error-illustration mb-8">
          {% if cfg.statusCode == 404 %}
            <div class="error-404-illustration">
              <div class="relative w-32 h-32 mx-auto">
                <div class="absolute inset-0 navbar-modern rounded-full"></div>
                <div class="absolute inset-4 border-4 border-dashed border-neutral-300/30 rounded-full"></div>
                <i class="fas fa-search absolute inset-0 flex items-center justify-center text-3xl text-neutral-400"></i>
              </div>
            </div>
          {% elif cfg.statusCode == 500 %}
            <div class="error-500-illustration">
              <div class="relative w-32 h-32 mx-auto">
                <div class="absolute inset-0 navbar-modern rounded-xl"></div>
                <i class="fas fa-server absolute inset-0 flex items-center justify-center text-3xl text-error"></i>
                <div class="absolute -top-2 -right-2 w-6 h-6 bg-error rounded-full flex items-center justify-center">
                  <i class="fas fa-times text-white text-xs"></i>
                </div>
              </div>
            </div>
          {% else %}
            <div class="error-generic-illustration">
              <div class="relative w-32 h-32 mx-auto navbar-modern rounded-2xl flex items-center justify-center">
                <i class="{{ finalIcon }} text-4xl text-error"></i>
              </div>
            </div>
          {% endif %}
        </div>
        <span class="error-status-code text-4xl font-bold text-error block mb-4">{{ cfg.statusCode }}</span>
      {% endif %}
    </div>

    {# Error Content #}
    <div class="error-content max-w-md mx-auto">
      <h1 class="error-title text-2xl font-semibold text-sand-100 mb-4">{{ finalTitle }}</h1>
      <p class="error-message text-neutral-300 mb-6 leading-relaxed">{{ finalMessage }}</p>
      
      {# Additional Details #}
      {% if cfg.details %}
        <div class="error-details mb-6 p-4 navbar-modern rounded-xl text-left">
          <h3 class="text-sand-200 font-medium text-sm mb-2">Details:</h3>
          <p class="text-neutral-400 text-sm">{{ cfg.details }}</p>
        </div>
      {% endif %}

      {# Stack Trace (Development) #}
      {% if cfg.showStack and cfg.stack %}
        <details class="error-stack-trace text-left mb-6">
          <summary class="text-sand-200 font-medium text-sm cursor-pointer mb-2">Show Technical Details</summary>
          <pre class="mt-4 text-left text-xs bg-neutral-900/50 p-4 rounded-md overflow-auto max-w-xl text-neutral-400"><code>{{ cfg.stack }}</code></pre>
        </details>
      {% endif %}
    </div>

    {# Error Actions #}
    <div class="error-actions flex flex-col sm:flex-row gap-4 items-center justify-center">
      {% if cfg.actions.showHome %}
        <a href="/" class="btn btn-primary">
          <i class="fas fa-home mr-2"></i>
          Return Home
        </a>
      {% endif %}
      
      {% if cfg.actions.showBack %}
        <button onclick="history.back()" class="btn btn-secondary">
          <i class="fas fa-arrow-left mr-2"></i>
          Go Back
        </button>
      {% endif %}
      
      {% if cfg.actions.showRefresh %}
        <button onclick="window.location.reload()" class="btn btn-outline">
          <i class="fas fa-refresh mr-2"></i>
          Try Again
        </button>
      {% endif %}

      {% for action in cfg.actions.custom %}
        {% if action.href %}
          <a href="{{ action.href }}" 
             class="btn {{ action.variant or 'btn-outline' }}"
             {% if action.external %}target="_blank" rel="noopener noreferrer"{% endif %}>
            {% if action.icon %}<i class="{{ action.icon }} mr-2"></i>{% endif %}
            {{ action.text }}
          </a>
        {% else %}
          <button onclick="{{ action.onclick or '' }}" 
                  class="btn {{ action.variant or 'btn-outline' }}"
                  {% if action.disabled %}disabled{% endif %}>
            {% if action.icon %}<i class="{{ action.icon }} mr-2"></i>{% endif %}
            {{ action.text }}
          </button>
        {% endif %}
      {% endfor %}
    </div>

    {# Help Text #}
    {% if cfg.statusCode == 404 %}
      <div class="error-help-text mt-8 text-sm text-neutral-400">
        If you typed the URL directly, please check your spelling and try again.
      </div>
    {% elif cfg.statusCode >= 500 %}
      <div class="error-help-text mt-8 text-sm text-neutral-400">
        This issue has been automatically reported. Please try again in a few minutes.
      </div>
    {% endif %}
  </section>
{% endmacro %}

{# Shortcut components for common error types #}
{% macro Error404(title = null, message = null, showBack = true) %}
  {{ ErrorPage({
    statusCode: 404,
    title: title,
    message: message,
    variant: 'illustrated',
    actions: {
      showHome: true,
      showBack: showBack,
      showRefresh: false
    }
  }) }}
{% endmacro %}

{% macro Error500(title = null, message = null, showDetails = false, stack = null) %}
  {{ ErrorPage({
    statusCode: 500,
    title: title,
    message: message,
    variant: 'modern',
    showStack: showDetails,
    stack: stack,
    actions: {
      showHome: true,
      showBack: false,
      showRefresh: true
    }
  }) }}
{% endmacro %}

{% macro Error403(title = null, message = null, loginUrl = null) %}
  {% set customActions = [] %}
  {% if loginUrl %}
    {% set customActions = [{ text: 'Sign In', href: loginUrl, icon: 'fas fa-sign-in-alt', variant: 'btn-primary' }] %}
  {% endif %}

  {{ ErrorPage({
    statusCode: 403,
    title: title,
    message: message,
    variant: 'modern',
    actions: {
      showHome: true,
      showBack: true,
      custom: customActions
    }
  }) }}
{% endmacro %}

{% macro Error401(title = null, message = null, loginUrl = '/login') %}
  {{ ErrorPage({
    statusCode: 401,
    title: title,
    message: message,
    variant: 'modern',
    actions: {
      showHome: false,
      showBack: true,
      custom: [
        { text: 'Sign In', href: loginUrl, icon: 'fas fa-sign-in-alt', variant: 'btn-primary' }
      ]
    }
  }) }}
{% endmacro %}

{% macro ErrorMaintenance(title = 'Under Maintenance', message = null, estimatedTime = null) %}
  {% set maintenanceMessage = message or 'We\'re currently performing scheduled maintenance to improve your experience.' %}
  {% if estimatedTime %}
    {% set maintenanceMessage = maintenanceMessage + ' Estimated completion: ' + estimatedTime + '.' %}
  {% endif %}

  {{ ErrorPage({
    statusCode: 503,
    title: title,
    message: maintenanceMessage,
    variant: 'illustrated',
    icon: 'fas fa-tools',
    actions: {
      showHome: false,
      showBack: false,
      showRefresh: true,
      custom: [
        { text: 'Check Status', href: '/status', icon: 'fas fa-chart-line', variant: 'btn-outline' }
      ]
    }
  }) }}
{% endmacro %}

{# Inline error components for use within pages #}
{% macro InlineError(message, variant = 'error', dismissible = false, actions = []) %}
  <div class="inline-error-container p-4 rounded-xl border {{ 'bg-error/20 border-error text-error' if variant == 'error' else 'bg-warning/20 border-warning text-warning' }} mb-4" 
       role="alert">
    <div class="flex items-start justify-between">
      <div class="flex items-start">
        <div class="flex-shrink-0 mr-3">
          <i class="{{ 'fas fa-exclamation-circle' if variant == 'error' else 'fas fa-exclamation-triangle' }} text-lg"></i>
        </div>
        <div class="flex-grow">
          <p class="font-medium text-sm">{{ message }}</p>
          {% if actions | length > 0 %}
            <div class="mt-3 flex space-x-3">
              {% for action in actions %}
                {% if action.href %}
                  <a href="{{ action.href }}" class="text-sm underline hover:no-underline">
                    {{ action.text }}
                  </a>
                {% else %}
                  <button onclick="{{ action.onclick or '' }}" class="text-sm underline hover:no-underline">
                    {{ action.text }}
                  </button>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
      {% if dismissible %}
        <button onclick="this.parentElement.parentElement.remove()" 
                class="flex-shrink-0 ml-4 text-sm opacity-70 hover:opacity-100 transition-opacity">
          <i class="fas fa-times"></i>
        </button>
      {% endif %}
    </div>
  </div>
{% endmacro %}

{% macro EmptyStateError(title = 'No Data Available', message = 'There\'s nothing here yet.', icon = 'fas fa-inbox', actions = []) %}
  <div class="empty-state-error text-center py-12">
    <div class="w-20 h-20 mx-auto mb-6 navbar-modern rounded-2xl flex items-center justify-center">
      <i class="{{ icon }} text-3xl text-neutral-400"></i>
    </div>
    <h3 class="text-lg font-semibold text-sand-200 mb-2">{{ title }}</h3>
    <p class="text-neutral-400 mb-6 max-w-sm mx-auto">{{ message }}</p>
    {% if actions | length > 0 %}
      <div class="flex flex-col sm:flex-row gap-3 items-center justify-center">
        {% for action in actions %}
          {% if action.href %}
            <a href="{{ action.href }}" class="btn {{ action.variant or 'btn-primary' }}">
              {% if action.icon %}<i class="{{ action.icon }} mr-2"></i>{% endif %}
              {{ action.text }}
            </a>
          {% else %}
            <button onclick="{{ action.onclick or '' }}" class="btn {{ action.variant or 'btn-primary' }}">
              {% if action.icon %}<i class="{{ action.icon }} mr-2"></i>{% endif %}
              {{ action.text }}
            </button>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endmacro %} 